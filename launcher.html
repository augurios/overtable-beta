<html>
<head>
	<title>Overtable | POS </title>
	<meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
	
	<script src="vendors/bower_components/angular/angular.min.js"></script>
	<script src="vendors/bower_components/angular-local-storage/dist/angular-local-storage.min.js"></script>
	<script src="ui-bootstrap-tpls-2.5.0.min.js"></script>
	<link href="vendors/bower_components/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
	

<script type="text/javascript">
	
const {BrowserWindow} = require('electron').remote
	
	
	setTimeout(function(){ 
		
		var element = document.getElementById("mainFrame");
		element.classList.add("loaded");
		
		
		}, 10000);
	
	var window = require('electron').remote.getCurrentWindow();
	 // Printing API 
    var win =  require('electron').remote.getCurrentWebContents();
    
    var http = require('http');
    console.log("remote window:", window);
     // printers = require('electron').remote.app.mainWindow.contents.getPrinters();
     printers = win.getPrinters();
      	
	  http.createServer(function (req, res) {
	  	
		if (req.url == '/printers') {
			
			res.setHeader('Access-Control-Allow-Origin', req.headers.origin);
			res.setHeader('Access-Control-Request-Method', '*');
			res.setHeader('Access-Control-Allow-Methods', 'OPTIONS, GET, POST, PUT');
			res.setHeader('Access-Control-Allow-Headers', "access-control-allow-credentials,access-control-allow-headers,access-control-allow-methods,access-control-allow-origin,if-modified-since,x-access-token"); 
	        res.writeHead(200, {'Content-Type': 'text/plain'});
			res.end(JSON.stringify(printers));
	    } 
		else if (req.url == '/printinvoice') {
	       var bodyR = [];
	        req.on('data', function(chunk) {
		         bodyR.push(chunk);
	        });
	       
	       req.on('end', function() {
		       
		        bodyR = Buffer.concat(bodyR).toString();
		        //console.log('test ',bodyR);
			  //console.log(JSON.parse(bodyR));
			  var printJob = JSON.parse(bodyR);
			  
			  //map template
			  var legalnameHolder = document.getElementById("invoice-legalname");
			  var restnameHolder = document.getElementById("invoice-restname");
			  var addressHolder = document.getElementById("invoice-address");
			  var phoneHolder = document.getElementById("invoice-phone");
			  var cedulaHolder = document.getElementById("invoice-cedula");
			  var disclaimerHolder = document.getElementById("invoice-disclaimer");
			  var wifiHolder = document.getElementById("invoice-wifi");
			  var nameHolder = document.getElementById("invoice-name");
			  var tableHolder = document.getElementById("invoice-table");
			  var numberHolder = document.getElementById("invoice-number");
			  var servedHolder = document.getElementById("invoice-served");
			  var dateHolder = document.getElementById("invoice-date");
			  var timeHolder = document.getElementById("invoice-time");
			  var statusHolder = document.getElementById("invoice-status");
			  var ordersHolder = document.getElementById("item-container");
			  var totalHolder = document.getElementById("invoice-total");
			  var gtotalHolder = document.getElementById("invoice-grandtotal");
			  var dollarHolder = document.getElementById("invoice-dollartotal");
			  
			  //inject data into template
			  restnameHolder.innerHTML = printJob.restName;
			  legalnameHolder.innerHTML = printJob.legalName 
			  phoneHolder.innerHTML = printJob.phone 
			  addressHolder.innerHTML = printJob.address
			  cedulaHolder.innerHTML = printJob.cJuridica
			  disclaimerHolder.innerHTML = printJob.disclaimer 
			  wifiHolder.innerHTML = printJob.wifi
			  nameHolder.innerHTML = printJob.clientName;
			  numberHolder.innerHTML = printJob.number;
			  servedHolder.innerHTML = printJob.servedBy;
			  dollarHolder.innerHTML = printJob.totalDollar.toFixed(2);
			  
			  var times = printJob.date.split('T');
			  dateHolder.innerHTML = times[0];
			  timeHolder.innerHTML = times[1];
			  if(printJob.table) {
				  tableHolder.innerHTML = printJob.table;
			  }
			  
			  
			  if (printJob.open) {
				  statusHolder.innerHTML = " - CUENTA PENDIENTE - ";
			  } else {
				  statusHolder.innerHTML = " - CUENTA CERRADA - "
			  };
			  
			   var simpleOrders = [];
			  
			   printJob.orders.forEach(function(element, index) {
			   		simpleOrders.push(""+element.product.Name+","+element.product.Price);
			   })
			   
			   simpleOrders.sort();
			  
			  var output = [];
			  
			  for (var i=0; i<simpleOrders.length; i++)
				{
				    if (!output[output.length-1] || output[output.length-1].Product != simpleOrders[i])
				        output.push({Product: simpleOrders[i],times: 1})
				    else
				        output[output.length-1].times++;   
				}
				
				var sortedAndCount = []
				
				output.forEach(function(element, index) {
					
					var product = element.Product.split(",");
					var priced = 0;
					
					for (var i=0; i<element.times; i++) {
						priced += parseInt(product[1]);
						console.log("wuut",priced, i);
					}
					
			   		sortedAndCount.push({product:{Name:product[0],Price:priced},times:element.times});
			    })
				
				
			   
			  for (var i = 0; i < sortedAndCount.length; i++) {
				  var new_row = document.createElement('tr');
				  new_row.className = "item";
				  
				  var new_row_quant = document.createElement('td');
				  var quant = document.createTextNode(sortedAndCount[i].times); 
				  new_row_quant.appendChild(quant); 
				  new_row.appendChild(new_row_quant);
				  
				  var new_row_name = document.createElement('td');
				  var name = document.createTextNode(sortedAndCount[i].product.Name); 
				  new_row_name.appendChild(name); 
				  new_row.appendChild(new_row_name);
				  
				  var new_row_price = document.createElement('td');
				  var price = document.createTextNode(sortedAndCount[i].product.Price); 
				  new_row_price.appendChild(price); 
				  new_row.appendChild(new_row_price);
				  
				  var content = new_row;
				  
				  //console.log(typeof content, content);
				  ordersHolder.appendChild(content);
			  }
			  
			  totalHolder.innerHTML = printJob.prices.total;
			  gtotalHolder.innerHTML = printJob.prices.grandtotal;
			  
		      
		   	   var d = document.getElementById("invoice-box");
		   	   d.classList.add("active");
		   	   
		   	   
		   	   
		      win.print({silent:true,deviceName:printJob.printer });
		      
			  
			  
			  setTimeout(function(){ 
		
				d.classList.remove("active");
				ordersHolder.innerHTML = "";
				
				
				}, 100);
			  
		      return 
		    });
	        res.setHeader('Access-Control-Allow-Origin', req.headers.origin);
			res.setHeader('Access-Control-Request-Method', 'POST');
			res.setHeader('Access-Control-Allow-Methods', 'POST');
			res.setHeader('Access-Control-Allow-Headers', "access-control-allow-credentials,access-control-allow-headers,access-control-allow-methods,access-control-allow-origin,content-type,x-access-token"); 
	        res.writeHead(200, {'Content-Type': 'text/plain'});
	       res.end("printing");
	      
	    } 
		else if (req.url == '/printorder') {
	       
	        req.on('data', function(chunk) {
		        
			  console.log("printing this", JSON.parse(chunk));
			 var printJob = JSON.parse(chunk);
			 var jobtable = "",
			 	 jobnotes = "",
			 	 jobvariation = "",
			 	 jobtime = "";
			 	    
			  if(printJob.tableName) {
				  	  jobtable = printJob.tableName + ' - ' + printJob.tableNum.toString();
				  } else {
					  jobtable = " - "
				  }
			    if(printJob.note) {
					  jobnotes = printJob.note;
				  }
				  
				  if(printJob.variation) {
				  	jobvariation = printJob.variation;
				  }
				  
				  if (printJob.time) {
					  var d = new Date(printJob.time);
					  jobtime = d.toLocaleTimeString();;
				  }
			
			
				  var winOrder = new BrowserWindow({width: 300, height: 600, show: false});
				  
				  winOrder.loadURL("file://" + __dirname + "/public/orders.html?productname="+printJob.product.Name+"&client="+printJob.client+"&table="+jobtable+"&time="+jobtime+"&notes="+jobnotes+"&variation="+jobvariation);
				 	
				 var timeout = 1 + (500 * printJob.waitFactor) + 8000;
				
					setTimeout(function(){ 
							console.log("printing order after timeout:", timeout);				
						    winOrder.webContents.print({silent:true,deviceName:printJob.printer });			
					
					}, timeout);
					
					var returnOut = timeout + 6000;
					
				return setTimeout(function(){ 
											
							
								
							winOrder.close();
							console.log("closing order window");			
					
					}, returnOut); 
				 
		    });
	       
	       res.setHeader('Access-Control-Allow-Origin', req.headers.origin);
			res.setHeader('Access-Control-Request-Method', 'POST');
			res.setHeader('Access-Control-Allow-Methods', 'POST');
			res.setHeader('Access-Control-Allow-Headers', "access-control-allow-credentials,access-control-allow-headers,access-control-allow-methods,access-control-allow-origin,content-type,x-access-token"); 
	        res.writeHead(200, {'Content-Type': 'text/plain'});
	       res.end("printing");
	       
	       
	    }
		else if (req.url == '/printreport') {
	       
	        req.on('data', function(chunk) {
			  console.log('print job:',JSON.parse(chunk));
			 var printJob = JSON.parse(chunk);
			  
			  //map template
			  var dateHolder = document.getElementById("shift-date");
			  var invoicesHolder = document.getElementById("shift-invoices");
			  var ordersHolder = document.getElementById("shift-orders");
			  var cashHolder = document.getElementById("shift-totalCash");
			  var creditHolder = document.getElementById("shift-totalCredit");
			  var totalHolder = document.getElementById("shift-grandTotal");
			  var taxHolder = document.getElementById("shift-tax");
			  var employHolder = document.getElementById("shift-employScore");
			  var startHolder = document.getElementById("shift-start");
			  var creatorHolder = document.getElementById("shift-creator");
			  var closedHolder = document.getElementById("shift-closed");			  
			  
			  //inject data into template
			  dateHolder.innerHTML = printJob.starttime;
			  invoicesHolder.innerHTML = printJob.invoices.length;
			  ordersHolder.innerHTML = printJob.orders.length;
			  cashHolder.innerHTML = printJob.totalCash;
			  creditHolder.innerHTML = printJob.totalCredit;
			  totalHolder.innerHTML = printJob.grandTotal;
			  taxHolder.innerHTML = printJob.tax;
			  startHolder.innerHTML = printJob.openingBalance;
			  creatorHolder.innerHTML = printJob.created_by;
			  closedHolder.innerHTML = printJob.closingBalance;
			  
			  for (var i = 0; i < printJob.employeeScore.length; i++) {
				  var new_row = document.createElement('li');
				  var empt = printJob.employeeScore[i].Employee + ' - ' + printJob.employeeScore[i].Percentage.toFixed(2);
				  var quant = document.createTextNode(empt);
				  new_row.appendChild(quant); 
				  
				  var content = new_row;
				  
				  //console.log(typeof content, content);
				  employHolder.appendChild(content);
			  }
			  
			  
		   	   var d = document.getElementById("report-box");
		   	   d.classList.add("active");
		     
		      win.print({silent:true,deviceName:printJob.printer });
		      
				
				
				 setTimeout(function(){ 
		
					 d.classList.remove("active");
					 employHolder.innerHTML = "";
				
				}, 200);
										     
		      return 
		    });
	       
	       res.setHeader('Access-Control-Allow-Origin', req.headers.origin);
			res.setHeader('Access-Control-Request-Method', 'POST');
			res.setHeader('Access-Control-Allow-Methods', 'POST');
			res.setHeader('Access-Control-Allow-Headers', "access-control-allow-credentials,access-control-allow-headers,access-control-allow-methods,access-control-allow-origin,content-type,x-access-token"); 
	        res.writeHead(200, {'Content-Type': 'text/plain'});
	       res.end("printing");
	    } 
		else if (req.url == '/exit') {
			res.setHeader('Access-Control-Allow-Origin', req.headers.origin);
			res.setHeader('Access-Control-Request-Method', '*');
			res.setHeader('Access-Control-Allow-Methods', 'OPTIONS, GET, POST, PUT');
			res.setHeader('Access-Control-Allow-Headers', "access-control-allow-credentials,access-control-allow-headers,access-control-allow-methods,access-control-allow-origin,if-modified-since,x-access-token"); 
	        res.writeHead(200, {'Content-Type': 'text/plain'});
			
			window.close();
			res.end(JSON.stringify({'message':'exit'}));
		} 
	    
	  }).listen(10086);
	
	
	
	  	

</script>

<style>
	body,
	html {
		width: 100%;
		display: block;
		height: 100%;
		border: 0;
		padding: 0;
		margin: 0;
		overflow: hidden;
		background: url('public/assets/img/logo.png');
		background-repeat: no-repeat;
		background-position: center center;
		background-size: cover;
		
		
		}	
	#mainFrame{
		width: 100%;
		display: block;
		height: 100%;
		border: 0;
		padding: 0;
		margin: 0;
		opacity: 0;
		transition: opacity 1s ease;
	}
	
	#mainFrame.loaded {
		opacity: 1;
		position: relative;
		z-index: 2;
	}
	
	.invoice-box,
	.order-box {
		display: none;
	}
	
	p#version {
	    position: absolute;
	    bottom: 0;
	    left: 15px;
	    font-weight: bold;
	    z-index: 1;
	}
	
	
	#update-alert {
	    position: fixed;
	    bottom: 0;
	    left: 0;
	    right: 0;
	    width: 100%;
	    background: #43A546;
	    z-index: 100;
	    padding: 12px 15px 2px;
	    display: none;
	}
	
	#update-alert a {
		color: #FFF;
		font-weight: bold;
	}
	
	#update-alert.active {
		display: block;
		z-index: 10000;
	}
		
</style>

<link rel="stylesheet" href="public/print-style.css" type="text/css" media="print" /><!-- media="print"-->

</head>
<body>
	

<iframe src="http://localhost:9000" frameborder="0" id="mainFrame"></iframe>

			
<div class="invoice-box" id="invoice-box">
	
	<table cellpadding="0" cellspacing="0">   
		<tbody>
			<tr class="top">   
				<td colspan="2">   
					<table>   
						<tbody>
							<tr>   
								<td class="title">   
									<h3><span id="invoice-legalname"></span></h3>
									<h1><span id="invoice-restname"></span></h1>
									<p><span id="invoice-address"></span></p>
									<p>Tel.: <span id="invoice-phone"></span></p>
									<p>Cedula Juridica <span id="invoice-cedula"></span></p>
								</td>   
								  
								</tr>   
						</tbody>
					</table>   
				</td>   
			</tr>   
			<tr class="information">   
				<td colspan="2">   
					<table>   
						<tbody>
							<tr>   
								<td>   
									Factura <span id="invoice-number"></span> <br>
									Recepción: <span id="invoice-served"></span><br>
									Cliente: <span id="invoice-name"></span><br>
									Mesa: <span id="invoice-table"></span>
									
								</td>   
								<td>   
									  <span id="invoice-date"></span> <br>
									  <span id="invoice-time"></span> 
									  
									
								</td>   
							</tr>  
					    </tbody>
					</table>   
				</td>   
			</tr>   
					
					
					 
					 <tr>
						 <td colspan="2">   
							<table>   
								<thead>
									 <tr class="heading">   
										 <td>   Cantidad   </td>  
										 <td>   Producto   </td>   
										 <td>   Precio   </td>  
									 </tr> 
								</thead>
								<tbody id="item-container">
								</tbody>
							</table>
						 </td>
						 
					 </tr>
					   
					  
					  
					  
					  <tr class="total">   <td></td>   <td>   Sub-Total: <span id="invoice-total"></span>    </td>   </tr>  
					 <tr class="total">   <td></td>   <td>   Total: <span id="invoice-grandtotal"></span>    </td>   </tr>    <tr class="total">   <td></td>   <td>   Total $: <span id="invoice-dollartotal"></span>    </td>   </tr>
					 
					  <tr class="status">      <td colspan="2">   <span id="invoice-status"></span>    </td>   </tr> 
					  <tr class="disclaimer">  
						      <td colspan="2">  
							     <span id="invoice-disclaimer"></span> <br>
						  					Clave WIFI: <span id="invoice-wifi"></span>
						  					 <br>
						  					  <br>
						  					  - <small style="font-size: 8px">by Overtable.disruptive.pro</small> -
						  					
						     </td>   
					</tr> 
				 </tbody>
				 </table>  
			</div>

<div class="report-box" id="report-box">


	<table cellpadding="0" cellspacing="0">   
		<tbody>
			<tr>   
				<td colspan="2">   
					<table>   
						<tbody>
							<tr>   
								<td class="title">
								
										<h1>Cierre de Caja</h1>
										
										<span id="shift-date">4:68 pm</span>  
										<h5>Cuentas: <span id="shift-invoices"></span></h5>
					                    <h5>Ordenes: <span id="shift-orders"></span></h5>
					                    <h4>Impuesto de Venta: <span id="shift-tax"></span></h4>
					                    <h4>Total Efectivo: <span id="shift-totalCash"></span></h4>
					                    <h4>Total Credit: <span id="shift-totalCredit"></span></h4>
					                    <h3>Total Ventas: <span id="shift-grandTotal"></span></h3>
										
										<h3>10% Empleados</h3>
										<ul id="shift-employScore">
											
										</ul>
										
										<h3> Historial de Caja</h3>
										
										<ul>
											<li><strong>Caja Abierta:</strong> <span id="shift-start"></span> por <span id="shift-creator"></span> </li>
											<li><strong>Caja Cerrada:</strong> <span id="shift-closed"></span>  </li>
										</ul>
										<ul>
											
										</ul>
										
										
										
									
								</td>
							</tr>
						</tbody>
					</table>
				</td>
			</tr>
			
			
			<tr>
				<td>
					<p >-&nbsp;<small style="font-size: 8px">by Overtable.disruptive.pro</small> -</p>
				</td>
			</tr>

		</tbody>
	</table>
							
	
</div>

<p id="version"></p>

<div id="update-alert">
	<!--<p><a href="#" onClick="window.close();">Actualmente hay una nueva version de Overtable disponible, haga click aquí para obtenerla inmediatamente.</a></p> -->
	<p><a href="#" onClick="window.close();">Actualmente hay una nueva version de Overtable lista para instalar, Por favor haga click aquí para lanzar el instalador.</a></p>
</div>
<script>
	var versionHolder = document.getElementById("version");
	var urlParams = new URLSearchParams(window.location.search);		
	var urlString = urlParams.toString() 
	var urlArr = urlString.split("=");
	
    versionHolder.innerHTML = urlArr[1];
    
    // Listen for messages
	const {ipcRenderer} = require('electron');
	ipcRenderer.on('message', function(event, text) {
		
		versionHolder.innerHTML = urlArr[1] +" - "+ text;
		
		
		if(text === "Update downloaded") {
			versionHolder.innerHTML = urlArr[1] +" - Actualizacion Disponible.";;
			var updater = document.getElementById("update-alert");
			updater.classList.add("active");
		}
			
		/*if(text === "Update downloaded") {
			versionHolder.innerHTML = text;
			var updater = document.getElementById("update-alert");
			updater.classList.add("active");
		} */
		
	});
	
</script>
</body>
</html>